<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OOD Detection with NegRefine – MapReduce</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f7f9fb;
      color: #2c3e50;
      line-height: 1.7;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      padding: 40px 24px;
      background: #ffffff;
    }

    h1 {
      font-size: 2.4em;
      border-bottom: 3px solid #3498db;
      padding-bottom: 12px;
    }

    h2 {
      margin-top: 45px;
      color: #2980b9;
    }

    h3 {
      margin-top: 28px;
      color: #34495e;
    }

    .meta {
      color: #7f8c8d;
      font-style: italic;
      margin-bottom: 30px;
    }

    .overview {
      background: #eef6ff;
      border-left: 5px solid #3498db;
      padding: 20px 25px;
      margin: 35px 0;
    }

    code {
      background: #f1f1f1;
      padding: 3px 6px;
      border-radius: 4px;
      font-family: Consolas, monospace;
      font-size: 0.95em;
    }

    pre {
      background: #2d3436;
      color: #ecf0f1;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 14px;
      max-height: 480px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background: #f2f6f9;
    }

    .highlight {
      color: #c0392b;
      font-weight: bold;
    }

    .success {
      margin-top: 30px;
      padding: 18px;
      background: #eafaf1;
      border-left: 5px solid #27ae60;
      font-weight: bold;
      color: #1e8449;
    }

    footer {
      margin-top: 70px;
      text-align: center;
      color: #95a5a6;
      font-size: 0.9em;
    }
  </style>
</head>

<body>
  <div class="container">

    <h1>Phát hiện dữ liệu ngoài phân phối (OOD) với NegRefine</h1>

    <div class="meta">
      Môn học: Phân tích dữ liệu lớn  
      <br/>
      Công nghệ: Hadoop MapReduce · CLIP · NegRefine (ICCV 2025)  
      <br/>
      Ngày thực hiện: 28 / 12 / 2025
    </div>

    <div class="overview">
      <strong>Tổng quan đề tài</strong>
      <ul>
        <li>Bài toán: Phát hiện dữ liệu ngoài phân phối (Out-of-Distribution Detection)</li>
        <li>Mục tiêu: Phân biệt ảnh thuộc tập huấn luyện (ID) và ảnh ngoài tập (OOD)</li>
        <li>Phương pháp: CLIP kết hợp NegRefine</li>
        <li>Triển khai: Hadoop MapReduce để xử lý dữ liệu quy mô lớn</li>
      </ul>
    </div>

    <h2>1. Giới thiệu bài toán</h2>
    <p>
      Trong các hệ thống học sâu hiện đại, mô hình thường được huấn luyện trên
      một tập dữ liệu xác định (In-Distribution – ID). Khi gặp dữ liệu chưa từng
      xuất hiện trong quá trình huấn luyện (Out-of-Distribution – OOD), mô hình
      có thể đưa ra dự đoán sai nhưng với độ tin cậy cao.
    </p>
    <p>
      Do đó, bài toán <strong>OOD Detection</strong> đóng vai trò quan trọng trong
      việc đảm bảo an toàn và độ tin cậy của hệ thống AI, đặc biệt trong các ứng
      dụng thực tế như nhận diện hình ảnh, y tế và xe tự hành.
    </p>

    <h2>2. Phương pháp NegRefine</h2>
    <p>
      NegRefine là một phương pháp phát hiện OOD được đề xuất tại ICCV 2025,
      hoạt động dựa trên mô hình CLIP. Thay vì chỉ đo độ tương đồng giữa ảnh và
      nhãn dương (positive labels), NegRefine khai thác thêm tập nhãn tiêu cực
      (negative labels) để tăng khả năng phân biệt giữa ID và OOD.
    </p>

    <p>
      Điểm OOD cuối cùng của một ảnh được tính theo công thức:
    </p>

    <pre>
S(x) = S<sub>NegLabel</sub>(x) + α · S<sub>MM</sub>(x)
    </pre>

    <p>
      Trong đó:
      <ul>
        <li><strong>S<sub>NegLabel</sub></strong>: độ tương đồng cao nhất với các nhãn tiêu cực</li>
        <li><strong>S<sub>MM</sub></strong>: điểm multi-matching giữa ảnh và tập nhãn</li>
        <li><strong>α</strong>: hệ số điều chỉnh</li>
      </ul>
    </p>

    <h2>3. Chuẩn bị dữ liệu</h2>
    <p>
      Dữ liệu đầu vào được tổ chức dưới dạng danh sách ảnh, mỗi dòng gồm đường dẫn
      ảnh và nhãn ID/OOD. File <code>img_list.txt</code> có dạng:
    </p>

    <pre>
/kaggle/input/imagenet/val/img01.jpg|ID_imagenet
/kaggle/input/places/val/img02.jpg|OOD_places
/kaggle/input/inaturalist/val/img03.jpg|OOD_inaturalist
    </pre>

    <h2>4. Triển khai MapReduce</h2>

    <h3>4.1 Mapper – Trích xuất đặc trưng ảnh</h3>
    <p>
      Mapper chịu trách nhiệm đọc từng ảnh, sử dụng mô hình CLIP để trích xuất
      vector đặc trưng và chuẩn hóa vector này. Quá trình này được thực hiện song
      song trên nhiều node trong Hadoop cluster.
    </p>

    <pre>
import torch, clip, sys, json
from PIL import Image

device = "cuda" if torch.cuda.is_available() else "cpu"
model, preprocess = clip.load("ViT-B/16", device=device)

for line in sys.stdin:
    img_path, tag = line.strip().split("|")
    image = Image.open(img_path).convert("RGB")
    x = preprocess(image).unsqueeze(0).to(device)

    with torch.no_grad():
        feat = model.encode_image(x)
        feat /= feat.norm(dim=-1, keepdim=True)

    print(f"{tag}\t{feat.cpu().tolist()}")
    </pre>

    <h3>4.2 Reducer – Tính điểm OOD</h3>
    <p>
      Reducer tổng hợp các đặc trưng, tính điểm NegRefine cho từng tập dữ liệu
      và đánh giá hiệu quả bằng các chỉ số như AUROC và FPR95.
    </p>

    <h2>5. Kết quả thực nghiệm</h2>

    <table>
      <tr>
        <th>Tiêu chí</th>
        <th>Xử lý tuần tự</th>
        <th>MapReduce</th>
        <th>Nhận xét</th>
      </tr>
      <tr>
        <td>Thời gian xử lý</td>
        <td>~1025 giây</td>
        <td class="highlight">~222 giây</td>
        <td>Tăng tốc ~4.6 lần</td>
      </tr>
      <tr>
        <td>AUROC</td>
        <td>0.9245</td>
        <td>0.9245</td>
        <td>Giữ nguyên độ chính xác</td>
      </tr>
    </table>

    <h2>6. Kết luận</h2>
    <p>
      Bài thực hành đã minh họa cách kết hợp một phương pháp OOD Detection hiện đại
      với Hadoop MapReduce để xử lý dữ liệu hình ảnh quy mô lớn. Việc phân tán
      quá trình trích xuất đặc trưng và tính điểm giúp giảm đáng kể thời gian xử lý
      mà vẫn giữ nguyên chất lượng kết quả.
    </p>

    <div class="success">
      Hệ thống có thể mở rộng cho các tập dữ liệu OOD lớn như NINCO và iNaturalist.
    </div>

    <footer>
      © 2025 · Phân tích dữ liệu lớn · NegRefine + MapReduce
    </footer>

  </div>
</body>
</html>
